// Generated by CoffeeScript 1.6.2
(function() {
  var app, async, client, config, express, fs, models, passport, port, server;

  express = require('express');

  app = express();

  server = require('http').createServer(app);

  passport = require('passport');

  config = require('./config/config');

  fs = require('fs');

  models = __dirname + '/models';

  fs.readdirSync(models).forEach(function(file) {
    return require(models + '/' + file);
  });

  require('./config/passport')(passport, config);

  require('./config/express')(app, passport);

  require('./config/routes')(app, passport);

  client = require('phonegap-build-api');

  async = require('async');

  config = require('../phonegapbuildconfig');

  client.auth({
    username: config.username,
    password: config.password
  }, function(e, api) {
    return api.get('/apps', function(err, apps) {
      var refresh;

      apps = apps.apps;
      refresh = function() {
        var i, tasks, _fn, _i, _ref;

        tasks = [];
        _fn = function(app) {
          return tasks.push(function(cb) {
            console.log("Refreshing " + app.title);
            return api.put("/apps/" + app.id + "}", {
              'pull': true
            }, function(e, data) {
              if (e) {
                console.log('Pull Error : ', e);
              }
              return api.post("/apps/" + app.id + "/build/ios", function(e, data) {
                if (e) {
                  console.log(' Build Error : ', e);
                }
                return cb();
              });
            });
          });
        };
        for (i = _i = 0, _ref = apps.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
          app = apps[i];
          _fn(app);
        }
        return async.series(tasks, function() {
          return console.log("Done refreshing apps on ", new Date());
        });
      };
      setInterval(function() {
        return refresh();
      }, 60000);
      return refresh();
    });
  });

  port = process.env.PORT || 3000;

  server.listen(port, function() {
    return console.log("Server running on port " + port);
  });

}).call(this);
